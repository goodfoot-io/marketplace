#!/bin/bash

# create-scratchpad-playwright-test: Create isolated Playwright test environment in project scratchpad
# Usage: create-scratchpad-playwright-test "project-name" "test-name"
# Purpose: Automate Playwright test setup for assumption testing

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to show help
show_help() {
    cat << EOF
create-scratchpad-playwright-test - Create isolated Playwright test environment for E2E assumption testing

USAGE:
    create-scratchpad-playwright-test "project-name" "test-name"

DESCRIPTION:
    Creates a standalone Playwright test environment in a project's scratchpad directory.
    This is used for E2E testing of browser behaviors, real WebSocket connections, or DOM interactions.

ARGUMENTS:
    project-name    Name of an existing project (must exist in projects/*)
    test-name       Name for the test (kebab-case format)

WHAT IT CREATES:
    projects/[status]/[project-name]/scratchpad/[test-name]/
    ├── yarn.lock              (empty, for workspace isolation)
    ├── package.json           (Playwright dependencies configured)
    ├── playwright.config.ts   (Browser configuration)
    └── [test-name].spec.ts    (test scaffold)

EXAMPLE:
    create-scratchpad-playwright-test "fix-websocket-bug" "connection-states"

    This creates:
    - projects/new/fix-websocket-bug/scratchpad/connection-states/
    - Installs Playwright with browser automation
    - Creates connection-states.spec.ts ready for E2E testing

NEXT STEPS:
    1. cd to the test directory
    2. Add any libraries to test: yarn add [library-name]
    3. Edit the test file
    4. Run: yarn test (runs against http://localhost:5173)
    5. Document findings in findings.md

NOTE:
    Playwright tests expect a dev server running at http://localhost:5173
    Start the website dev server before running tests:
    cd packages/website && yarn dev

EOF
    exit 1
}

# Validate arguments
if [ $# -ne 2 ]; then
    echo -e "${RED}Error: Exactly 2 arguments required${NC}" >&2
    echo ""
    show_help
fi

PROJECT_NAME="$1"
TEST_NAME="$2"

# Validate test name format (kebab-case)
if ! echo "$TEST_NAME" | grep -qE '^[a-z0-9][a-z0-9-]*[a-z0-9]$'; then
    echo -e "${RED}Error: Invalid test name format. Use lowercase letters, numbers, and hyphens (kebab-case)${NC}" >&2
    exit 1
fi

# Find workspace root
WORKSPACE_ROOT=""
current_dir="$(pwd)"
while [ "$current_dir" != "/" ]; do
    if [ -d "$current_dir/projects" ]; then
        WORKSPACE_ROOT="$current_dir"
        break
    fi
    current_dir="$(dirname "$current_dir")"
done

if [ -z "$WORKSPACE_ROOT" ]; then
    echo -e "${RED}Error: Could not find workspace root with projects directory${NC}" >&2
    exit 1
fi

cd "$WORKSPACE_ROOT"

# Find project in any status directory
PROJECT_PATH=""
for status_dir in new pending active ready-for-review complete icebox; do
    if [ -d "projects/$status_dir/$PROJECT_NAME" ]; then
        PROJECT_PATH="projects/$status_dir/$PROJECT_NAME"
        break
    fi
done

if [ -z "$PROJECT_PATH" ]; then
    echo -e "${RED}Error: Project '$PROJECT_NAME' not found in any status directory${NC}" >&2
    exit 1
fi

# Create scratchpad directory if it doesn't exist
SCRATCHPAD_DIR="$PROJECT_PATH/scratchpad"
if [ ! -d "$SCRATCHPAD_DIR" ]; then
    mkdir -p "$SCRATCHPAD_DIR"
fi

# Create test directory
TEST_DIR="$SCRATCHPAD_DIR/$TEST_NAME"
if [ -d "$TEST_DIR" ]; then
    echo -e "${RED}Error: Test directory already exists: $TEST_DIR${NC}" >&2
    exit 1
fi

mkdir -p "$TEST_DIR"

# Create empty yarn.lock for workspace isolation
touch "$TEST_DIR/yarn.lock"

# Create package.json
cat > "$TEST_DIR/package.json" << EOF
{
  "name": "$TEST_NAME",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "test": "playwright test",
    "test:ui": "playwright test --ui",
    "test:debug": "playwright test --debug"
  },
  "devDependencies": {
    "@playwright/test": "^1.54.1",
    "@types/node": "^24.1.0",
    "typescript": "^5.8.3"
  },
  "dependencies": {}
}
EOF

# Create playwright.config.ts
cat > "$TEST_DIR/playwright.config.ts" << 'EOF'
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: '.',
  timeout: 30 * 1000,
  expect: {
    timeout: 5000
  },
  fullyParallel: true,
  forbidOnly: true,
  retries: 0,
  workers: 1,
  reporter: 'list',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure'
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    }
  ],
  // Commented out webServer config - start dev server manually
  // webServer: {
  //   url: 'http://localhost:5173',
  //   reuseExistingServer: true,
  //   timeout: 10 * 1000
  // }
});
EOF

# Create test file
test_content="import { test, expect } from '@playwright/test';

test.describe('$TEST_NAME E2E assumption test', () => {
  test('should validate [TODO: describe what you are testing]', async ({ page }) => {
    // TODO: Add your test implementation
    // Example: Navigate to a test page
    // await page.goto('/test-page');
    
    // Example: Wait for an element
    // await expect(page.locator('#some-element')).toBeVisible();
    
    // Example: Check WebSocket connection
    // const status = await page.locator('#connection-status').textContent();
    // expect(status).toBe('connected');
    
    expect(true).toBe(true); // Placeholder assertion
  });
});"

printf '%s\n' "$test_content" > "$TEST_DIR/$TEST_NAME.spec.ts"

# Install dependencies
echo -e "${YELLOW}Installing dependencies...${NC}"
cd "$TEST_DIR"
if yarn install > /dev/null 2>&1; then
    echo -e "${GREEN}✓ Dependencies installed successfully${NC}"
else
    echo -e "${RED}Warning: Failed to install dependencies. You may need to run 'yarn install' manually${NC}" >&2
fi

# Output success message and file list
echo -e "${GREEN}✓ Created Playwright test environment${NC}"
echo ""
echo -e "${YELLOW}Files created:${NC}"
find "$WORKSPACE_ROOT/$TEST_DIR" -type f -not -path "*/node_modules/*" -exec echo "  {}" \; | sort
echo ""
echo -e "${RED}Important: Start dev server first:${NC}"
echo -e "${GREEN}cd $WORKSPACE_ROOT/packages/website && yarn dev${NC}"
echo ""
echo -e "${YELLOW}To run the test:${NC}"
echo -e "${GREEN}cd $WORKSPACE_ROOT/$TEST_DIR && yarn test${NC}"
echo ""
echo -e "${YELLOW}To run with UI mode:${NC}"
echo -e "${GREEN}cd $WORKSPACE_ROOT/$TEST_DIR && yarn test:ui${NC}"

# Return to original directory
cd "$WORKSPACE_ROOT"