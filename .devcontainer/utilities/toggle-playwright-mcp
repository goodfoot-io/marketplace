#!/bin/bash

# toggle-playwright-mcp - Enable or disable the playwright MCP server

set -e

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Path to Claude configuration file
CLAUDE_CONFIG="/home/node/.claude/.claude.json"

# Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo -e "${RED}Error: jq is not installed. Please install jq to use this utility.${NC}"
    exit 1
fi

# Check if claude command exists
if ! command -v claude &> /dev/null; then
    echo -e "${RED}Error: claude command not found. Please ensure Claude CLI is installed.${NC}"
    exit 1
fi

# Check if config file exists
if [ ! -f "$CLAUDE_CONFIG" ]; then
    echo -e "${YELLOW}Warning: Claude config file not found at $CLAUDE_CONFIG${NC}"
    echo "Creating minimal config..."
    mkdir -p "$(dirname "$CLAUDE_CONFIG")"
    echo '{}' > "$CLAUDE_CONFIG"
fi

# Check if playwright MCP server is currently installed
is_installed() {
    if claude mcp list 2>&1 | grep -q "^playwright:"; then
        return 0
    else
        return 1
    fi
}

# Main logic
if is_installed; then
    echo -e "${YELLOW}Playwright MCP server is currently enabled${NC}"
    echo "Disabling playwright MCP server..."
    
    if claude mcp remove playwright; then
        echo -e "${GREEN}✓ Playwright MCP server has been disabled${NC}"
    else
        echo -e "${RED}✗ Failed to disable playwright MCP server${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}Playwright MCP server is currently disabled${NC}"
    echo "Enabling playwright MCP server..."
    
    # Additional environment variables for stealth mode
    if claude mcp add playwright \
        --env PLAYWRIGHT_BROWSERS_PATH=/home/node/.cache/ms-playwright \
        --env PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1 \
        --env NODE_ENV=production \
        --env PLAYWRIGHT_CHROMIUM_USE_PIPE=1 \
        -- npx @playwright/mcp@latest --config /workspace/.devcontainer/playwright-config.json; then
        echo -e "${GREEN}✓ Playwright MCP server has been enabled with stealth mode${NC}"
        echo -e "${BLUE}ℹ Stealth features activated:${NC}"
        echo "  • Bot detection evasion enabled"
        echo "  • Realistic browser fingerprinting"
        echo "  • Human-like interaction patterns"
        echo "  • Enhanced header spoofing"
    else
        echo -e "${RED}✗ Failed to enable playwright MCP server${NC}"
        exit 1
    fi
fi

# Show current status
echo
echo "Current MCP server status:"
if is_installed; then
    echo -e "${GREEN}Playwright MCP server: ENABLED${NC}"
    echo -e "${BLUE}Configuration: /workspace/.devcontainer/playwright-config.json${NC}"
    echo -e "${BLUE}Mode: Stealth browsing with anti-bot detection${NC}"
else
    echo -e "${RED}Playwright MCP server: DISABLED${NC}"
fi

# Show tips for usage
echo
echo -e "${BLUE}Tips for avoiding bot detection:${NC}"
echo "  • Browser runs in non-headless mode for better detection avoidance"
echo "  • WebDriver property is hidden from navigator object"
echo "  • Realistic user agent and headers are configured"
echo "  • Random delays simulate human interaction patterns"
echo "  • Canvas and WebGL fingerprints are spoofed"