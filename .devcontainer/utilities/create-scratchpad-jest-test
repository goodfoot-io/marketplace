#!/bin/bash

# create-scratchpad-jest-test: Create isolated Jest test environment in project scratchpad
# Usage: create-scratchpad-jest-test "project-name" "test-name"
# Purpose: Automate Jest test setup for assumption testing

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to show help
show_help() {
    cat << EOF
create-scratchpad-jest-test - Create isolated Jest test environment for assumption testing

USAGE:
    create-scratchpad-jest-test "project-name" "test-name"

DESCRIPTION:
    Creates a standalone Jest test environment in a project's scratchpad directory.
    This is used for testing assumptions about libraries, APIs, or behaviors in isolation.

ARGUMENTS:
    project-name    Name of an existing project (must exist in projects/*)
    test-name       Name for the test (kebab-case format)

WHAT IT CREATES:
    projects/[status]/[project-name]/scratchpad/[test-name]/
    ├── yarn.lock         (empty, for workspace isolation)
    ├── package.json      (Jest dependencies configured)
    ├── jest.config.js    (TypeScript ESM configuration)
    └── [test-name].test.ts (test scaffold)

EXAMPLE:
    create-scratchpad-jest-test "fix-auth-bug" "jwt-validation"

    This creates:
    - projects/new/fix-auth-bug/scratchpad/jwt-validation/
    - Installs Jest and TypeScript
    - Creates jwt-validation.test.ts ready for testing

NEXT STEPS:
    1. cd to the test directory
    2. Add any libraries to test: yarn add [library-name]
    3. Edit the test file
    4. Run: yarn test
    5. Document findings in findings.md

EOF
    exit 1
}

# Validate arguments
if [ $# -ne 2 ]; then
    echo -e "${RED}Error: Exactly 2 arguments required${NC}" >&2
    echo ""
    show_help
fi

PROJECT_NAME="$1"
TEST_NAME="$2"

# Validate test name format (kebab-case)
if ! echo "$TEST_NAME" | grep -qE '^[a-z0-9][a-z0-9-]*[a-z0-9]$'; then
    echo -e "${RED}Error: Invalid test name format. Use lowercase letters, numbers, and hyphens (kebab-case)${NC}" >&2
    exit 1
fi

# Find workspace root
WORKSPACE_ROOT=""
current_dir="$(pwd)"
while [ "$current_dir" != "/" ]; do
    if [ -d "$current_dir/projects" ]; then
        WORKSPACE_ROOT="$current_dir"
        break
    fi
    current_dir="$(dirname "$current_dir")"
done

if [ -z "$WORKSPACE_ROOT" ]; then
    echo -e "${RED}Error: Could not find workspace root with projects directory${NC}" >&2
    exit 1
fi

cd "$WORKSPACE_ROOT"

# Find project in any status directory
PROJECT_PATH=""
for status_dir in new pending active ready-for-review complete icebox; do
    if [ -d "projects/$status_dir/$PROJECT_NAME" ]; then
        PROJECT_PATH="projects/$status_dir/$PROJECT_NAME"
        break
    fi
done

if [ -z "$PROJECT_PATH" ]; then
    echo -e "${RED}Error: Project '$PROJECT_NAME' not found in any status directory${NC}" >&2
    exit 1
fi

# Create scratchpad directory if it doesn't exist
SCRATCHPAD_DIR="$PROJECT_PATH/scratchpad"
if [ ! -d "$SCRATCHPAD_DIR" ]; then
    mkdir -p "$SCRATCHPAD_DIR"
fi

# Create test directory
TEST_DIR="$SCRATCHPAD_DIR/$TEST_NAME"
if [ -d "$TEST_DIR" ]; then
    echo -e "${RED}Error: Test directory already exists: $TEST_DIR${NC}" >&2
    exit 1
fi

mkdir -p "$TEST_DIR"

# Create empty yarn.lock for workspace isolation
touch "$TEST_DIR/yarn.lock"

# Create package.json
cat > "$TEST_DIR/package.json" << EOF
{
  "name": "$TEST_NAME",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "test": "NODE_OPTIONS=\"--experimental-vm-modules\" jest",
    "test:watch": "NODE_OPTIONS=\"--experimental-vm-modules\" jest --watch"
  },
  "devDependencies": {
    "@jest/globals": "^29.7.0",
    "@types/jest": "^29.5.14",
    "@types/node": "^24.1.0",
    "jest": "^29.7.0",
    "ts-jest": "^29.2.5",
    "typescript": "^5.8.3"
  },
  "dependencies": {}
}
EOF

# Create jest.config.js
cat > "$TEST_DIR/jest.config.js" << 'EOF'
/** @type {import('jest').Config} */
export default {
  preset: 'ts-jest/presets/default-esm',
  testEnvironment: 'node',
  extensionsToTreatAsEsm: ['.ts'],
  moduleNameMapper: {
    '^(\\.{1,2}/.*)\\.js$': '$1'
  },
  transform: {
    '^.+\\.tsx?$': [
      'ts-jest',
      {
        useESM: true,
        tsconfig: {
          module: 'ESNext',
          target: 'ESNext',
          moduleResolution: 'node',
          esModuleInterop: true,
          skipLibCheck: true,
          strict: true,
          noEmit: true,
          resolveJsonModule: true,
          allowJs: true,
          checkJs: false
        }
      }
    ]
  },
  testMatch: ['<rootDir>/**/*.test.ts'],
  testPathIgnorePatterns: ['/node_modules/'],
  moduleFileExtensions: ['ts', 'js', 'json', 'node']
};
EOF

# Create test file
test_content="import { describe, it, expect } from '@jest/globals';

describe('$TEST_NAME assumption test', () => {
  it('should validate [TODO: describe what you are testing]', async () => {
    // TODO: Add your test implementation
    expect(true).toBe(true);
  }, 10000); // 10 second timeout for async operations
});"

printf '%s\n' "$test_content" > "$TEST_DIR/$TEST_NAME.test.ts"

# Install dependencies
echo -e "${YELLOW}Installing dependencies...${NC}"
cd "$TEST_DIR"
if yarn install > /dev/null 2>&1; then
    echo -e "${GREEN}✓ Dependencies installed successfully${NC}"
else
    echo -e "${RED}Warning: Failed to install dependencies. You may need to run 'yarn install' manually${NC}" >&2
fi

# Output success message and file list
echo -e "${GREEN}✓ Created Jest test environment${NC}"
echo ""
echo -e "${YELLOW}Files created:${NC}"
find "$WORKSPACE_ROOT/$TEST_DIR" -type f -not -path "*/node_modules/*" -exec echo "  {}" \; | sort
echo ""
echo -e "${YELLOW}To run the test:${NC}"
echo -e "${GREEN}cd $WORKSPACE_ROOT/$TEST_DIR && yarn test${NC}"

# Return to original directory
cd "$WORKSPACE_ROOT"