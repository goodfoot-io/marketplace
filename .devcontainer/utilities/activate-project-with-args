#!/bin/bash

# activate-project-with-args - Activate a project by name or from arguments
# Usage: activate-project-with-args [PROJECT-NAME]
#
# This utility combines multiple steps:
# 1. Writes arguments to synchronize user input
# 2. Gets the next eligible project
# 3. Waits for project selection
# 4. Activates the project if found
# 5. Displays activation status and project files

# Capture all arguments as the full user statement
PROJECT_NAME="$*"

# Write all arguments to synchronize user input
if ! write-arguments "$*"; then
    echo "Error: Failed to write arguments" >&2
    exit 1
fi

# Select project based on arguments or find the oldest eligible one
SELECTED_PROJECT=$(get-next-project)

# Wait for project selection to complete (timeout: 2 seconds)
PROJECT_PATH=$(wait-for-project-name 2)

# Check if project was found
if [ -n "$PROJECT_PATH" ]; then
    # Activate the project
    ACTIVE_PROJECT=$(activate-project "$PROJECT_PATH")
    
    if [ -n "$ACTIVE_PROJECT" ]; then
        echo "Activated: $ACTIVE_PROJECT"
        echo "Review @$ACTIVE_PROJECT/plan.md and @$ACTIVE_PROJECT/log.md"
        exit 0
    else
        echo "Error: Failed to activate project $PROJECT_PATH" >&2
        exit 1
    fi
else
    echo "Project not found or has unmet dependencies"
    exit 1
fi