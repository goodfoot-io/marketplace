# Development environment configuration
# This file automatically loads branch-specific environment variables using direnv
#
# Setup instructions:
# 1. Install direnv: https://direnv.net/docs/installation.html
#    - macOS: brew install direnv
#    - Ubuntu: apt install direnv
#    - See docs for other platforms
#
# 2. Add direnv hook to your shell (~/.bashrc or ~/.zshrc):
#    eval "$(direnv hook bash)"  # for bash
#    eval "$(direnv hook zsh)"   # for zsh
#
# 3. Allow this file to run:
#    direnv allow
#
# 4. Create your branch-specific environment file:
#    cp environment/.env.branch.template environment/.env.branch.main

# Detect current git branch
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# Handle detached HEAD state gracefully
if [[ -z "$BRANCH" ]]; then
    echo "direnv: Detached HEAD state detected, using default environment"
    BRANCH="detached"
fi

# Sanitize branch name for use as filename (convert / to .)
SAFE_BRANCH="${BRANCH//\//.}"

# Export branch information
export GIT_BRANCH="$BRANCH"
export ENVIRONMENT="$SAFE_BRANCH"

# Load branch-specific environment file if it exists
BRANCH_ENV="environment/.env.branch.$SAFE_BRANCH"
if [[ -f "$BRANCH_ENV" ]]; then
    echo "direnv: ✓ Loading environment for branch '$BRANCH'"
    dotenv "$BRANCH_ENV"
else
    # Branch environment file doesn't exist yet
    # Try to copy from previous branch (detected via reflog)
    PREVIOUS_BRANCH=$(git reflog | grep -E "checkout: moving from .* to $BRANCH" | head -n 1 | awk '{print $6}')

    if [[ -n "$PREVIOUS_BRANCH" ]]; then
        # Sanitize previous branch name
        SAFE_PREVIOUS="${PREVIOUS_BRANCH//\//.}"
        PREVIOUS_ENV="environment/.env.branch.$SAFE_PREVIOUS"

        if [[ -f "$PREVIOUS_ENV" ]]; then
            # Copy from previous branch (like old git hook system)
            echo "direnv: ⚠ No environment file for branch '$BRANCH'"
            echo "direnv:   Copying from previous branch '$PREVIOUS_BRANCH'"
            cp "$PREVIOUS_ENV" "$BRANCH_ENV"
            echo "direnv:   Created $BRANCH_ENV"
            echo "direnv: ✓ Loading environment for branch '$BRANCH'"
            dotenv "$BRANCH_ENV"
        elif [[ -f "environment/.env.branch.template" ]]; then
            # Previous branch env doesn't exist, copy from template
            echo "direnv: ⚠ No environment file for branch '$BRANCH'"
            echo "direnv:   Copying from template"
            cp "environment/.env.branch.template" "$BRANCH_ENV"
            echo "direnv:   Created $BRANCH_ENV"
            echo "direnv: ✓ Loading environment for branch '$BRANCH'"
            dotenv "$BRANCH_ENV"
        else
            # No template available
            echo "direnv: ⚠ No template found at environment/.env.branch.template"
            echo "direnv:   Please create a template file"
        fi
    elif [[ -f "environment/.env.branch.template" ]]; then
        # Can't determine previous branch, copy from template
        echo "direnv: ⚠ No environment file for branch '$BRANCH'"
        echo "direnv:   Copying from template"
        cp "environment/.env.branch.template" "$BRANCH_ENV"
        echo "direnv:   Created $BRANCH_ENV"
        echo "direnv: ✓ Loading environment for branch '$BRANCH'"
        dotenv "$BRANCH_ENV"
    else
        # No template available
        echo "direnv: ⚠ No template found at environment/.env.branch.template"
        echo "direnv:   Please create a template file"
    fi
fi

# Load personal local overrides (never committed to git)
# Priority order: branch-specific local > root local
# This allows personal secrets and machine-specific config

# Branch-specific local overrides (e.g., environment/.env.branch.main.env.local)
BRANCH_LOCAL="$BRANCH_ENV.env.local"
if [[ -f "$BRANCH_LOCAL" ]]; then
    echo "direnv: ✓ Loading branch-specific personal overrides from $BRANCH_LOCAL"
    dotenv "$BRANCH_LOCAL"
fi

# Root level local overrides (applies to all branches)
if [[ -f ".env.local" ]]; then
    echo "direnv: ✓ Loading personal overrides from .env.local"
    dotenv ".env.local"
fi

echo "direnv: Environment loaded for branch '$BRANCH' (ENVIRONMENT=$ENVIRONMENT)"
